### Описание Экспериментов с моделями `GradientBoostingRegressor` и `RandomForestRegressor`

## Цель

Предсказать **качество красного вина** по его физико-химическим характеристикам. Мы исследуем две ансамблевые модели: `RandomForestRegressor` и `GradientBoostingRegressor`. Все эксперименты проводились с трекингом через **MLflow**, данные — через **DVC**.

---

## Почему выбраны именно эти модели?

### Random Forest Regressor (Случайный лес)
- Работает "из коробки"
- Устойчив к переобучению
- Низкие требования к предобработке
- Хорошо справляется с табличными и шумными данными

### Gradient Boosting Regressor (Градиентный бустинг)
- Более высокая предсказательная мощность при правильной настройке
- Лучше улавливает сложные зависимости
- Используется как стандарт де-факто во многих ML-задачах 

---

## Методология

- **Датасет**: [`winequality-red.csv`](./data/winequality-red.csv)
- **Целевая переменная**: `quality`
- **Метрики оценки**:
  - `RMSE` — среднеквадратичная ошибка
  - `R²` — коэффициент детерминации
- **Разделение**: `train_test_split` (80% / 20%)
- **MLflow Tracking**:
  - Запуски логируются в `../mlruns`
  - Используются автоматические циклы с рандомизацией гиперпараметров
- **Версионирование моделей**:
  - Все сохранения идут через `joblib.dump()` 
  - Папка `model/` в DVC

---

## Результаты

| Модель                    | Лучшая RMSE | Лучшая R² |
|---------------------------|-------------|-----------|
| RandomForestRegressor     | **0.5576**  | **0.5241**|
| GradientBoostingRegressor| 0.5870     | 0.4725    |

---

## Выбор лучшей модели

**Выбрана модель: `RandomForestRegressor`**

**Плюсы:**
- Выдала лучшие метрики на тесте (`RMSE ↓`, `R² ↑`)
- Менее чувствительна к выбору гиперпараметров
- Быстрее обучается
- Надежна при шумных данных

**Минусы `GradientBoostingRegressor`:**
- В данной задаче не смог превзойти RF
- Требует тонкой настройки и оптимизации параметров
- Более подвержен переобучению на малых данных

---

## Можно ли добиться R² ≈ 1?

Нет, по следующим причинам:
- Оценка вина имеет **субъективную природу**
- Признаки (кислотность, сахар и т.д.) **не полностью объясняют качество**
- Наблюдается **шум**, **дисбаланс классов** и **ограниченный размер датасета**

---

## Артефакты экспериментов

-  `data/` — датасет под управлением DVC
-  `./experiments/model/` — сохраняется лучшая модель (`best_rf.pkl`), добавлена в DVC
-  `mlruns/` — НЕ включён в Git
-  `rf_experiment.py`, `gbr_experiment.py` — скрипты запуска экспериментов

---

## Скриншоты из MLflow
GBR
![эксперименты gbr](./experiments/experimentsres/gbrex.png)

RF
![эксперименты rf](./experiments/experimentsres/rfex.png)
---

# Инструкция по запуску компонентов


## Клонирование репозитория 

```bash
git clone https://github.com/neilarphy/mlops-block2-finalproject-wine-quality.git
cd mlops-block2-finalproject-wine-quality
```

##  Установка зависимостей

```bash
python -m venv .venv
.venv\Scripts\activate        
pip install -r requirements.txt
```

---

##  DVC: загрузка данных и модели
Скопируйте config.local из примера и заполните ключи доступа для DVC 
```bash
cp .dvc/config.local.example .dvc/config.local
```

Затем
```bash
dvc pull
```

---

## Обучение модели через Airflow

Модель обучается автоматически раз в день с помощью Apache Airflow. Все шаги — загрузка данных, обучение, логирование метрик и отправка в DVC — управляются DAG'ом (`train_model_daily`).

### 1. Поднимите Airflow:

```bash
docker-compose up --build
```
Airflow будет доступен по ссылке
http://localhost:8888

Логин пароль по умолчанию
airflow airflow

### 2. DAG: `train_model_daily`

- DAG запускается автоматически каждый день (`@daily`)
- Чтобы **запустить обучение вручную**:
  1. Откройте интерфейс Airflow
  2. Перейдите к DAG `train_model_daily`
  3. Нажмите «Trigger DAG»

Это запустит полный пайплайн:

- `dvc pull` — загрузка датасета
- обучение модели
- сохранение метрик
- `dvc add` и `dvc push` — обновление артефактов

### 3. Проверка логов

Логи каждой задачи (`pull`, `train`, `add`, `push`) доступны в UI Airflow по кнопке **Logs** рядом с нужной задачей.

---

## Запуск FastAPI-приложения

```bash
uvicorn src.api:app --reload --host 127.0.0.1 --port 8000
```

**Доступные эндпоинты:**
- [`/docs`](http://127.0.0.1:8000/docs) — Swagger UI
- [`/healthcheck`](http://127.0.0.1:8000/healthcheck) — проверка доступности модели
- [`/predict`](http://127.0.0.1:8000/predict) — предсказание
- [`/model-info`](http://127.0.0.1:8000/model-info) — информация о модели

---

## Запуск тестов

```bash
pytest tests/
```

## CI/CD через GitHub Actions

Файл workflow: `.github/workflows/ci.yml`

Триггеры:
- `push` в `main`
- `pull_request`
- ручной запуск (`workflow_dispatch`)

Этапы:
1. Линтинг (`flake8`)
2. Загрузка модели через `dvc pull`
3. Загрузка артефактов модели (`upload-artifact`)
4. Тестирование API (`pytest`)
